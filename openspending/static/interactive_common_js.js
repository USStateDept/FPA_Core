(function(d){var k=0;d.widget("ech.multiselect",{options:{header:!0,height:175,minWidth:225,classes:"",checkAllText:"Check all",uncheckAllText:"Uncheck all",noneSelectedText:"Select options",selectedText:"# selected",selectedList:0,show:null,hide:null,autoOpen:!1,multiple:!0,position:{}},_create:function(){var a=this.element.hide(),b=this.options;this.speed=d.fx.speeds._default;this._isOpen=!1;a=(this.button=d('<button type="button"><span class="ui-icon ui-icon-triangle-2-n-s"></span></button>')).addClass("ui-multiselect ui-widget ui-state-default ui-corner-all").addClass(b.classes).attr({title:a.attr("title"),"aria-haspopup":!0,tabIndex:a.attr("tabIndex")}).insertAfter(a);(this.buttonlabel=d("<span />")).html(b.noneSelectedText).appendTo(a);var a=(this.menu=d("<div />")).addClass("ui-multiselect-menu ui-widget ui-widget-content ui-corner-all").addClass(b.classes).appendTo(document.body),c=(this.header=d("<div />")).addClass("ui-widget-header ui-corner-all ui-multiselect-header ui-helper-clearfix").appendTo(a);(this.headerLinkContainer=d("<ul />")).addClass("ui-helper-reset").html(function(){return!0===b.header?'<li><a class="ui-multiselect-all" href="#"><span class="ui-icon ui-icon-check"></span><span>'+b.checkAllText+'</span></a></li><li><a class="ui-multiselect-none" href="#"><span class="ui-icon ui-icon-closethick"></span><span>'+b.uncheckAllText+"</span></a></li>":"string"===typeof b.header?"<li>"+b.header+"</li>":""}).append('<li class="ui-multiselect-close"><a href="#" class="ui-multiselect-close"><span class="ui-icon ui-icon-circle-close"></span></a></li>').appendTo(c);(this.checkboxContainer=d("<ul />")).addClass("ui-multiselect-checkboxes ui-helper-reset").appendTo(a);this._bindEvents();this.refresh(!0);b.multiple||a.addClass("ui-multiselect-single")},_init:function(){!1===this.options.header&&this.header.hide();this.options.multiple||this.headerLinkContainer.find(".ui-multiselect-all, .ui-multiselect-none").hide();this.options.autoOpen&&this.open();this.element.is(":disabled")&&this.disable()},refresh:function(a){var b=this.element,c=this.options,f=this.menu,h=this.checkboxContainer,g=[],e="",i=b.attr("id")||k++;b.find("option").each(function(b){d(this);var a=this.parentNode,f=this.innerHTML,h=this.title,k=this.value,b="ui-multiselect-"+(this.id||i+"-option-"+b),l=this.disabled,n=this.selected,m=["ui-corner-all"],o=(l?"ui-multiselect-disabled ":" ")+this.className,j;"OPTGROUP"===a.tagName&&(j=a.getAttribute("label"),-1===d.inArray(j,g)&&(e+='<li class="ui-multiselect-optgroup-label '+a.className+'"><a href="#">'+j+"</a></li>",g.push(j)));l&&m.push("ui-state-disabled");n&&!c.multiple&&m.push("ui-state-active");e+='<li class="'+o+'">';e+='<label for="'+b+'" title="'+h+'" class="'+m.join(" ")+'">';e+='<input id="'+b+'" name="multiselect_'+i+'" type="'+(c.multiple?"checkbox":"radio")+'" value="'+k+'" title="'+f+'"';n&&(e+=' checked="checked"',e+=' aria-selected="true"');l&&(e+=' disabled="disabled"',e+=' aria-disabled="true"');e+=" /><span>"+f+"</span></label></li>"});h.html(e);this.labels=f.find("label");this.inputs=this.labels.children("input");this._setButtonWidth();this._setMenuWidth();this.button[0].defaultValue=this.update();a||this._trigger("refresh")},update:function(){var a=this.options,b=this.inputs,c=b.filter(":checked"),f=c.length,a=0===f?a.noneSelectedText:d.isFunction(a.selectedText)?a.selectedText.call(this,f,b.length,c.get()):/\d/.test(a.selectedList)&&0<a.selectedList&&f<=a.selectedList?c.map(function(){return d(this).next().html()}).get().join(", "):a.selectedText.replace("#",f).replace("#",b.length);this.buttonlabel.html(a);return a},_bindEvents:function(){function a(){b[b._isOpen?"close":"open"]();return!1}
var b=this,c=this.button;c.find("span").bind("click.multiselect",a);c.bind({click:a,keypress:function(a){switch(a.which){case 27:case 38:case 37:b.close();break;case 39:case 40:b.open()}},mouseenter:function(){c.hasClass("ui-state-disabled")||d(this).addClass("ui-state-hover")},mouseleave:function(){d(this).removeClass("ui-state-hover")},focus:function(){c.hasClass("ui-state-disabled")||d(this).addClass("ui-state-focus")},blur:function(){d(this).removeClass("ui-state-focus")}});this.header.delegate("a","click.multiselect",function(a){if(d(this).hasClass("ui-multiselect-close"))b.close();else b[d(this).hasClass("ui-multiselect-all")?"checkAll":"uncheckAll"]();a.preventDefault()});this.menu.delegate("li.ui-multiselect-optgroup-label a","click.multiselect",function(a){a.preventDefault();var c=d(this),g=c.parent().nextUntil("li.ui-multiselect-optgroup-label").find("input:visible:not(:disabled)"),e=g.get(),c=c.parent().text();!1!==b._trigger("beforeoptgrouptoggle",a,{inputs:e,label:c})&&(b._toggleChecked(g.filter(":checked").length!==g.length,g),b._trigger("optgrouptoggle",a,{inputs:e,label:c,checked:e[0].checked}))}).delegate("label","mouseenter.multiselect",function(){d(this).hasClass("ui-state-disabled")||(b.labels.removeClass("ui-state-hover"),d(this).addClass("ui-state-hover").find("input").focus())}).delegate("label","keydown.multiselect",function(a){a.preventDefault();switch(a.which){case 9:case 27:b.close();break;case 38:case 40:case 37:case 39:b._traverse(a.which,this);break;case 13:d(this).find("input")[0].click()}}).delegate('input[type="checkbox"], input[type="radio"]',"click.multiselect",function(a){var c=d(this),g=this.value,e=this.checked,i=b.element.find("option");this.disabled||!1===b._trigger("click",a,{value:g,text:this.title,checked:e})?a.preventDefault():(c.focus(),c.attr("aria-selected",e),i.each(function(){this.value===g?this.selected=e:b.options.multiple||(this.selected=!1)}),b.options.multiple||(b.labels.removeClass("ui-state-active"),c.closest("label").toggleClass("ui-state-active",e),b.close()),b.element.trigger("change"),setTimeout(d.proxy(b.update,b),10))});d(document).bind("mousedown.multiselect",function(a){b._isOpen&&(!d.contains(b.menu[0],a.target)&&!d.contains(b.button[0],a.target)&&a.target!==b.button[0])&&b.close()});d(this.element[0].form).bind("reset.multiselect",function(){setTimeout(d.proxy(b.refresh,b),10)})},_setButtonWidth:function(){var a=this.element.outerWidth(),b=this.options;/\d/.test(b.minWidth)&&a<b.minWidth&&(a=b.minWidth);this.button.width(a)},_setMenuWidth:function(){var a=this.menu,b=this.button.outerWidth()-parseInt(a.css("padding-left"),10)-parseInt(a.css("padding-right"),10)-parseInt(a.css("border-right-width"),10)-parseInt(a.css("border-left-width"),10);a.width(b||this.button.outerWidth())},_traverse:function(a,b){var c=d(b),f=38===a||37===a,c=c.parent()[f?"prevAll":"nextAll"]("li:not(.ui-multiselect-disabled, .ui-multiselect-optgroup-label)")[f?"last":"first"]();c.length?c.find("label").trigger("mouseover"):(c=this.menu.find("ul").last(),this.menu.find("label")[f?"last":"first"]().trigger("mouseover"),c.scrollTop(f?c.height():0))},_toggleState:function(a,b){return function(){this.disabled||(this[a]=b);b?this.setAttribute("aria-selected",!0):this.removeAttribute("aria-selected")}},_toggleChecked:function(a,b){var c=b&&b.length?b:this.inputs,f=this;c.each(this._toggleState("checked",a));c.eq(0).focus();this.update();var h=c.map(function(){return this.value}).get();this.element.find("option").each(function(){!this.disabled&&-1<d.inArray(this.value,h)&&f._toggleState("selected",a).call(this)});c.length&&this.element.trigger("change")},_toggleDisabled:function(a){this.button.attr({disabled:a,"aria-disabled":a})[a?"addClass":"removeClass"]("ui-state-disabled");var b=this.menu.find("input"),b=a?b.filter(":enabled").data("ech-multiselect-disabled",!0):b.filter(function(){return!0===d.data(this,"ech-multiselect-disabled")}).removeData("ech-multiselect-disabled");b.attr({disabled:a,"arial-disabled":a}).parent()[a?"addClass":"removeClass"]("ui-state-disabled");this.element.attr({disabled:a,"aria-disabled":a})},open:function(){var a=this.button,b=this.menu,c=this.speed,f=this.options,h=[];if(!(!1===this._trigger("beforeopen")||a.hasClass("ui-state-disabled")||this._isOpen)){var g=b.find("ul").last(),e=f.show,i=a.offset();d.isArray(f.show)&&(e=f.show[0],c=f.show[1]||this.speed);e&&(h=[e,c]);g.scrollTop(0).height(f.height);d.ui.position&&!d.isEmptyObject(f.position)?(f.position.of=f.position.of||a,b.show().position(f.position).hide()):b.css({top:i.top+a.outerHeight(),left:i.left});d.fn.show.apply(b,h);this.labels.eq(0).trigger("mouseover").trigger("mouseenter").find("input").trigger("focus");a.addClass("ui-state-active");this._isOpen=!0;this._trigger("open")}},close:function(){if(!1!==this._trigger("beforeclose")){var a=this.options,b=a.hide,c=this.speed,f=[];d.isArray(a.hide)&&(b=a.hide[0],c=a.hide[1]||this.speed);b&&(f=[b,c]);d.fn.hide.apply(this.menu,f);this.button.removeClass("ui-state-active").trigger("blur").trigger("mouseleave");this._isOpen=!1;this._trigger("close")}},enable:function(){this._toggleDisabled(!1)},disable:function(){this._toggleDisabled(!0)},checkAll:function(){this._toggleChecked(!0);this._trigger("checkAll")},uncheckAll:function(){this._toggleChecked(!1);this._trigger("uncheckAll")},getChecked:function(){return this.menu.find("input").filter(":checked")},destroy:function(){d.Widget.prototype.destroy.call(this);this.button.remove();this.menu.remove();this.element.show();return this},isOpen:function(){return this._isOpen},widget:function(){return this.menu},getButton:function(){return this.button},_setOption:function(a,b){var c=this.menu;switch(a){case"header":c.find("div.ui-multiselect-header")[b?"show":"hide"]();break;case"checkAllText":c.find("a.ui-multiselect-all span").eq(-1).text(b);break;case"uncheckAllText":c.find("a.ui-multiselect-none span").eq(-1).text(b);break;case"height":c.find("ul").last().height(parseInt(b,10));break;case"minWidth":this.options[a]=parseInt(b,10);this._setButtonWidth();this._setMenuWidth();break;case"selectedText":case"selectedList":case"noneSelectedText":this.options[a]=b;this.update();break;case"classes":c.add(this.button).removeClass(this.options.classes).addClass(b);break;case"multiple":c.toggleClass("ui-multiselect-single",!b),this.options.multiple=b,this.element[0].multiple=b,this.refresh()}
d.Widget.prototype._setOption.apply(this,arguments)}})})(jQuery);(function(){window.config={"server":"/api/3","services":{"categories":"/categories","search":"/search"}}})();(function(){window.loader={};





window.loader.geoJson={};window.loader.geoJsonLayers={};window.loader.data=null;window.loader.indicator=null;window.loader.loadIndicatorList=function(url,handlerFunc){$.ajax({url:url,jsonp:"callback",dataType:"jsonp",data:{},success:handlerFunc});}
window.loader.loadIndicatorData=function(indicators,geounits,yearsExtremes){






var indicatorIds=indicators; var countries=_.remove(geounits,function(c){return c.indexOf(":")<0;});var groupsWithAllRegions=_.remove(geounits,function(c){return c.match(/:+/g).length==1&&c.indexOf(":all")==c.length-4;});var regionsWithAllCountries=_.remove(geounits,function(c){return c.match(/:+/g).length==2&&c.indexOf(":all")==c.length-4;});var regionsInGroups=geounits;var urlPrefix="/api/slicer/cube/geometry/cubes_aggregate?&cluster=jenks&numclusters=4&cubes={indicator_id}&cut=geometry__time:{yearFrom}-{yearTo}&order=time";urlPrefix=urlPrefix.replace(/{indicator_id}/g,indicatorIds.join("|"));urlPrefix=urlPrefix.replace(/{yearFrom}/g,yearsExtremes[0]);urlPrefix=urlPrefix.replace(/{yearTo}/g,yearsExtremes[1]);var urlCountriesTemplate=urlPrefix+"&drilldown=geometry__country_level0@name|geometry__time&cut=geometry__country_level0@name:{countries}"; var urlAllRegionsInGroupTemplate=urlPrefix+"&drilldown=geometry__country_level0@{groupId}|geometry__time";var urlRegionsInGroupTemplate=urlPrefix+"&drilldown=geometry__country_level0@{groupId}|geometry__time&cut=geometry__country_level0@{groupId}:{regions}";var urlAllCountriesInRegionsInGroupTemplate=urlPrefix+"&drilldown=geometry__country_level0@name|geometry__time&cut=geometry__country_level0@{groupId}:{regions}";






 var urls=[];if(countries.length){urls.push({url:urlCountriesTemplate.replace(/{countries}/g,countries.join(";")),level:"countries",geounits:countries});}
if(groupsWithAllRegions.length){_.forEach(groupsWithAllRegions,function(group){var groupId=group.substring(0,group.indexOf(":all"));urls.push({url:urlAllRegionsInGroupTemplate.replace(/{groupId}/g,groupId),level:"regions",geounits:groupId});});}
if(regionsWithAllCountries.length){ var groups=[],groupRegions={};_.forEach(regionsWithAllCountries,function(group){var groupId=group.substring(0,group.indexOf(":"));if(_.indexOf(groups,groupId)<0){groups.push(groupId);}});_.forEach(groups,function(groupId){groupRegions[groupId]=[];_.forEach(regionsWithAllCountries,function(group){var groupMatch=group.indexOf(groupId+":")==0;if(groupMatch){groupRegions[groupId].push(group.split(":")[1]);}});});for(groupId in groupRegions){urls.push({url:urlAllCountriesInRegionsInGroupTemplate.replace(/{groupId}/g,groupId).replace(/{regions}/g,groupRegions[groupId].join(";")),level:"countries",geounits:groupRegions[groupId]});}}
if(regionsInGroups.length){ var groups=[],groupRegions={};_.forEach(regionsInGroups,function(group){var groupId=group.substring(0,group.indexOf(":"));if(_.indexOf(groups,groupId)<0){groups.push(groupId);}});_.forEach(groups,function(groupId){groupRegions[groupId]=[];_.forEach(regionsInGroups,function(group){var groupMatch=group.indexOf(groupId+":")==0;if(groupMatch){groupRegions[groupId].push(group.split(":")[1]);}});});for(groupId in groupRegions){ if(groupRegions[groupId].length==1){groupRegions[groupId][0]+=";"+groupRegions[groupId][0];}
urls.push({url:urlRegionsInGroupTemplate.replace(/{groupId}/g,groupId).replace(/{regions}/g,groupRegions[groupId].join(";")),level:"regions",geounits:groupRegions[groupId]});}}
urls.push({url:urlPrefix+"&drilldown=geometry__time",level:"statistics",geounits:"global"});var defferreds=[];_.forEach(urls,function(item){var d=$.ajax({url:item.url,dataType:"json",data:{}});defferreds.push(d);});return defferreds;}
window.loader.loadCountries=function(url,handlerFunc){url="/api/3/countries_list";$.ajax({url:url,dataType:"json",data:{},success:handlerFunc});} 
window.loader.loadGeoJSON=function(type,handlerFunc,cluster){url="/static/json/"+type+"_None.geojson";$.ajax({url:url,dataType:"json",data:{},success:function(response){handlerFunc(response,type,cluster)}});}
window.loader.loadIndicatorsMeta=function(indicators){var defferreds=[];_.forEach(indicators,function(indicator){var url="/api/3/datasets/"+indicator;var deferred=$.ajax({url:url,dataType:"json",data:{}});defferreds.push(deferred);})
return defferreds;}
window.loader.loadUrlShorten=function(url){var deferred=$.ajax({url:url,dataType:"jsonp",jsonp:"callback",data:{}});return deferred;}}());var act;

(function(){window.utils={};window.utils.masterCells=[];window.utils.flipCardEvent=function(){$(".flip").click(function(){if(window.expandedCategory){window.expandedCategory=false;return;}
if(window.clickedIndicator){window.clickedIndicator=false;return;}
$(".flip").css("z-index",10);$(this).css("z-index",1000);$(".flip").find("div.list-group").removeClass("shadow");$(this).find("div.list-group").addClass("shadow");var isFlipped=$(this).find(".card").hasClass("flipped");$(".flip").find(".card").removeClass("flipped");$(".flip").removeClass("flippedCol");if(isFlipped){}else{$(this).find(".card").addClass("flipped");$(this).addClass("flippedCol");}
return true;});}
window.utils.getHashParams=function(){var hashParams={};var e,a=/\+/g, r=/([^&;=]+)=?([^&;]*)/g,d=function(s){return decodeURIComponent(s.replace(a," "));},q=window.location.hash.substring(1);while(e=r.exec(q))
hashParams[d(e[1])]=d(e[2]);return hashParams;}
window.utils.updateHash=function(hashObj){var result=decodeURIComponent($.param(hashObj));window.location.hash=result;}
window.utils.bindIndicators=function(response,model){var categoriesAll=response.data.categories;var subcategoriesAll=response.data.subcategories;var sourcesAll=response.data.sources;var indicatorsAll=response.data.indicators;var categoriesModel=[];var sourcesModel=[];var indicatorsModel=[]; for(var cat in categoriesAll.data){var isOnlyCategory=function(indicatorId){return indicatorsAll.data[indicatorId].subcategory==="None";}
var isSubCategory=function(indicatorId){return indicatorsAll.data[indicatorId].subcategory!="None";}
var makeIndicator=function(indicatorId){var sourceId=_.get(indicatorsAll,'data[indicatorId].source');var sourceLabel=_.get(sourcesAll,'data[sourceId].label');var cloneIndicator=_.clone(indicatorsAll.data[indicatorId],true);cloneIndicator.source=sourceLabel;cloneIndicator.id=indicatorId;cloneIndicator.selected=false;return cloneIndicator;}
var indicatorsIdsInCategory=_.filter(categoriesAll.data[cat].indicators,_.negate(isSubCategory));var indicatorsIdsInSubCategory=_.filter(categoriesAll.data[cat].indicators,_.negate(isOnlyCategory));var indicatorsInCategory=_.map(indicatorsIdsInCategory,makeIndicator);var indicatorsInSubCategory=_.map(indicatorsIdsInSubCategory,makeIndicator); var subcategories=[];var subcategoriesTracker=[];_.forEach(indicatorsInSubCategory,function(indicator){var subCatIndex=_.indexOf(subcategoriesTracker,indicator.subcategory);if(subCatIndex<0){var newSubCategory={"id":indicator.subcategory,"label":subcategoriesAll.data[indicator.subcategory].label,"indicators":[indicator],"selected":false}
subcategoriesTracker.push(indicator.subcategory);subcategories.push(newSubCategory);}else{subcategories[subCatIndex].indicators.push(indicator);}});if(subcategories.length>0&&indicatorsInCategory.length>0){var generalSubCategory={"label":"General","indicators":indicatorsInCategory,"selected":false}
subcategories.unshift(generalSubCategory);}
var newCategory={"label":categoriesAll.data[cat].label,"length":categoriesAll.data[cat].indicators.length,"indicators":indicatorsInCategory,"subcategories":subcategories}
categoriesModel.push(newCategory);} 
for(var src in sourcesAll.data){var indicatorsInSource=_.map(sourcesAll.data[src].indicators,function(indicatorId){var categoryId=_.get(sourcesAll,'data[indicatorId].category');var categoryLabel=_.get(sourcesAll,'data[categoryId].label');var cloneIndicator=_.clone(indicatorsAll.data[indicatorId],true);cloneIndicator.source=categoryLabel;cloneIndicator.id=indicatorId;cloneIndicator.selected=false;return cloneIndicator;});var newSource={"label":sourcesAll.data[src].label,"length":sourcesAll.data[src].indicators.length,"indicators":indicatorsInSource}
var newSourceArray=["MCC","CDA","DHS","SDG",,"UIS","WHO","IMF"];var label=newSource.label.split("-")[0].trim();if(newSourceArray.indexOf(label)!=-1){sourcesModel.push(newSource);}} 
for(var ind in indicatorsAll.data){var newIndicator=indicatorsAll.data[ind];var sourceId=newIndicator.source;var categoryId=newIndicator.category;newIndicator.source=_.get(sourcesAll,'data[sourceId].label');newIndicator.category=_.get(categoriesAll,'data[categoryId].label');newIndicator.id=ind;newIndicator.selected=false;indicatorsModel.push(newIndicator);}
model.categoriesModel(categoriesModel);model.sourcesModel(sourcesModel);model.indicatorsModel(indicatorsModel);model.indicatorsModelMaster(_.clone(indicatorsModel,true));};window.utils.bindCountries=function(response,model){var countryGroupings=_.clone(model.countryGroupings(),true); _.forEach(countryGroupings,function(countryGroup,i){var groupId=countryGroup.id;countryGroup.selected=false;countryGroup.filtered=false;countryGroup.geounit=groupId+":all";if(countryGroup.id!="all"){var trackRegion=[];_.forEach(response.data,function(country){
 var region=country.regions[groupId];var regionObj={id:region,label:region,geounit:groupId+":"+region,countries:[],selected:false,filtered:false}
if(_.indexOf(trackRegion,region)<0){trackRegion.push(region);countryGroup.regions.push(regionObj);}});}else{countryGroup.regions.push({ id:"all",label:"All Countries",countries:[],selected:false,filtered:false});}}); _.forEach(countryGroupings,function(countryGroup,i){_.forEach(countryGroup.regions,function(region){_.forEach(response.data,function(country){ var regionId=region.id;var c=countryGroup;if(country.regions[countryGroup.id]==regionId||regionId=="all"){country.selected=false;country.filtered=false;country.id=country.iso_a2;region.countries.push(country);}});});});model.countryGroupings.removeAll();_.forEach(countryGroupings,function(countryGroup,i){model.countryGroupings.push(countryGroup);});_.forEach(response.data,function(country){country.selected=false;});model.countriesModel(response.data);model.countriesModelMaster(_.clone(response.data,true));model.activeGroup(countryGroupings[0]);};window.utils.removeOnMap=function(model,geounits){
window.map.removeLayer(window.visualization.geoJsonLayers[level]);$.each(vizModel.activeCountries(),function(idx,country){window.utils.highlightOnMap(vizModel,country);});};window.utils.clearOnMap=function(model){
var levels=model.countryGroupings();
_.forEach(levels,function(_l){var layerId=_l.id;if(layerId=="all"){layerId="sovereignt";}
var layer=window.visualization.geoJsonLayers[layerId];if(layer){window.map.removeLayer(layer);}})};window.utils.zoomToFeatures=function(features){var group=new L.featureGroup(features);var bounds=group.getBounds();var southWestLng=bounds._southWest.lng;var northEastLng=bounds._northEast.lng;bounds._southWest.lng=bounds._southWest.lat;bounds._southWest.lat=southWestLng;bounds._northEast.lng=bounds._northEast.lat;bounds._northEast.lat=northEastLng;map.fitBounds(bounds);console.log("zoomed to features");console.timeEnd("choropleth");};window.utils.highlightOnMapViz=function(regions,type,cluster,indicator,gjson){if(window.loader.geoJsonLayers[type]){map.removeLayer(window.loader.geoJsonLayers[type]);}
var geojson=gjson['features'];var featuresAdded=[];var style=function(feature){var name=feature.properties.sovereignt||feature.properties.usaid_reg||feature.properties.continent||feature.properties.dod_cmd||feature.properties.dos_region||feature.properties.wb_inc_lvl;if(!name){return{weight:0,opacity:0,color:'white',dashArray:'3',fillOpacity:0.0,fillColor:'#666666'};}
if(regions[0].indexOf(":")>-1){name=type+":"+name;}else{ name=name.toLowerCase();}
if(_.indexOf(regions,name)>-1){var polygon=L.multiPolygon(feature.geometry.coordinates);featuresAdded.push(polygon);return{weight:2,opacity:1,color:'#FFFFFF',fillOpacity:0.5,fillColor:window.utils.getColor(feature.properties[indicator],cluster)
};}else{return{weight:0,opacity:0,color:'white',dashArray:'3',fillOpacity:0.0,fillColor:'#666666'};}}
var highlightFeature=function(){}
var resetHighlight=function(){}
var zoomToFeature=function(e){map.fitBounds(e.target.getBounds());}
var onEachFeature=function(feature,layer){console.log("onEachFeature");if(feature.properties){var name=feature.properties.sovereignt||feature.properties.usaid_reg||feature.properties.continent||feature.properties.dod_cmd||feature.properties.dos_region||feature.properties.wb_inc_lvl;var popupText=name;if(feature.properties[indicator]){popupText+="</br>"+feature.properties[indicator];}
layer.bindPopup(popupText);}
layer.on({mouseover:highlightFeature,mouseout:resetHighlight,click:zoomToFeature});}
map.once('layeradd',function(){window.utils.zoomToFeatures(featuresAdded);});window.loader.geoJsonLayers[type]=L.geoJson(window.loader.geoJson[type],{onEachFeature:onEachFeature,style:style});map.addLayer(window.loader.geoJsonLayers[type]);};window.utils.getColor=function(d,cluster){var breaks=cluster.data;var color='#CCCCCC'; var colorRamp=['#800026','#BD0026','#E31A1C','#FC4E2A','#FD8D3C','#FEB24C','#FED976','#FFEDA0'];_.forEach(breaks,function(_b,i){if(d>=_b){color=colorRamp[i];}})
return color;};window.utils.addLegend=function(cluster){var legend=L.control({position:'topright'});var breaks=cluster.data;var labels=cluster.labels;var legendLabels=[];legend.onAdd=function(map){var div=L.DomUtil.create('div','info legend'),grades=breaks;_.forEach(breaks,function(_b,i){var from=_.round(_b,2);var to=_.round(grades[i+1],2);legendLabels.push('<i style="background:'+window.utils.getColor(from+1,cluster)+'"></i> '+
from+(to?' &ndash; '+to:'+'));});legendLabels.push('<i style="background:#CCCCCC"></i> No Data');div.innerHTML=legendLabels.join('<br>');return div;};legend.addTo(map);};window.utils.highlightOnMap=function(model,geounit){var featuresAdded=[]; var isCountry=geounit.iso_a2;var drillDown=false;if(isCountry){level="sovereignt";}else{level=geounit.geounit.split(":")[0];drillDown=_.indexOf(geounit.geounit.split(":"),"all")>-1;} 
var activeCountries=model.activeCountries();act=activeCountries;var listOfLabels=_.map(activeCountries,function(_a){return _a.label;});var drillDownLabels=[];if(drillDown){if(geounit.countries){level="sovereignt";var drillDownLabels=_.map(geounit.countries,function(_a){return _a.label;});}
if(geounit.regions){level=geounit.geounit.split(":")[0];var drillDownLabels=_.map(geounit.regions,function(_a){return _a.label;});}}
window.map.removeLayer(window.visualization.geoJsonLayers[level]);var style=function(feature){if((drillDown&&(_.indexOf(drillDownLabels,feature.properties[level])>-1))||(feature.properties[level]==geounit.label)||_.indexOf(listOfLabels,feature.properties[level])>-1){var polygon=L.multiPolygon(feature.geometry.coordinates);featuresAdded.push(polygon);return{weight:2,opacity:1,color:'#FFFFFF',fillOpacity:0.5,fillColor:'#00FF00'};}else{return{weight:0,opacity:0,color:'white',dashArray:'3',fillOpacity:0.0,fillColor:'#666666'};}}
var onEachFeature=function(feature,layer){if(feature.properties){var name=feature.properties.sovereignt||feature.properties.usaid_reg||feature.properties.continent||feature.properties.dod_cmd||feature.properties.dos_region||feature.properties.wb_inc_lvl;layer.bindPopup(name);}}
window.visualization.geoJsonLayers[level]=L.geoJson(window.visualization.geoJson[level],{onEachFeature:onEachFeature,style:style});map.addLayer(window.visualization.geoJsonLayers[level]);return;setTimeout(function(){var group=new L.featureGroup(featuresAdded);var bounds=group.getBounds();var southWestLng=bounds._southWest.lng;var northEastLng=bounds._northEast.lng;bounds._southWest.lng=bounds._southWest.lat;bounds._southWest.lat=southWestLng;bounds._northEast.lng=bounds._northEast.lat;bounds._northEast.lat=northEastLng;map.fitBounds(bounds);},0);}
window.utils.prepareHighchartsJson=function(data,statsData,indicatorsMeta,type,indicators,yearsExtremesForData){var cells=data.cells;var statsCells=statsData.cells;var indicatorId=indicators[0];var title=indicators[0];var dataType="avg"; var multiVariate=indicators.length>1;
var fromYear=1990;var toYear=2015;var categories=[];for(var i=fromYear;i<=toYear;i++){categories.push(parseInt(i));}
var series={"Global Minimum":[],"Global Maximum":[],"Global Average":[],}; _.forEach(statsCells,function(c){series["Global Minimum"].push([c["geometry__time"],c[indicatorId+"__amount_min"]]);series["Global Maximum"].push([c["geometry__time"],c[indicatorId+"__amount_max"]]);series["Global Average"].push([c["geometry__time"],c[indicatorId+"__amount_avg"]]);});var seriesArray=[];if(window.utils.masterCells.length==0)
window.utils.masterCells=window.utils.masterCells.concat(cells);var _cells=cells;_.forEach(_cells,function(c){if(c.region){series[c.region]=[];}});_.forEach(_cells,function(c){if(c.region){series[c.region].push([c.year,c[indicatorId+"__amount_"+dataType]]);}});var titleArray=_.map(indicatorsMeta,function(meta){var title=meta[0].label;var units=meta[0].units;units=units==null?"":"("+units+")";return title+units;});var xUnits=indicatorsMeta[0][0].units;var yUnits;if(type=="scatter"||type=="bubble"){yUnits=indicatorsMeta[1][0].units;}
var zUnits;if(type=="bubble"){zUnits=indicatorsMeta[2][0].units;}
xUnits=xUnits==null?"":" ("+xUnits+")";yUnits=yUnits==null?"":" ("+yUnits+")";zUnits=zUnits==null?"":" ("+zUnits+")";var title=titleArray.join(" and ");var subtitleObj=_.map(indicatorsMeta,function(meta){return meta={"label":meta[0].label,"url":meta[0].url,"dataorg":meta[0].dataorg};});var subtitleArray=_.map(subtitleObj,function(subtitleArray,i){var source=subtitleObj[i].dataorg||'-';return subtitleArray=subtitleObj[i].label+' (<a href="" target="_blank">'+source+'</a>)';});var subtitle="Sources: "+subtitleArray.join(", ");var counter=1;var countriesArr=[];Object.size=function(obj){var size=0,key;for(key in obj){if(obj.hasOwnProperty(key))size++;}
return size;};var size=Object.size(series);for(var countryName in series){var visible=false;visible=true;
function inBounds(a){var inStatus=true;$.each(a,function(k,v){if(v[1]<1&&v[1]!=null){inStatus=false;}});return inStatus;}
seriesArray.push({name:countryName,data:series[countryName],visible:(counter>3||size==3)?true:false,zIndex:counter++});countriesArr.push(countryName);}
seriesArray[0].zIndex=seriesArray.length+1;seriesArray[1].zIndex=seriesArray.length+2;seriesArray[2].zIndex=seriesArray.length+3;var chartObj={type:type};if(type=="radar"){chartObj.polar=true;chartObj["type"]="line";}
var ymin=inBounds(series[countryName]); var jsonLine={chart:chartObj,title:{text:title,x:-20},subtitle:{text:subtitle,x:-20},xAxis:{ title:{enabled:true,text:'Years'},startOnTick:true,endOnTick:true,showLastLabel:true},yAxis:{title:{text:title},min:ymin?0:null,plotLines:[{value:0,width:0.25,color:'#FFFFCC'}]},tooltip:{valueSuffix:'',shared:false,pointFormat:'<span style="color:{point.color}">●</span> {series.name}: <b>{point.y:,.2f}</b><br/>'},legend:{layout:'vertical',align:'right',verticalAlign:'middle',borderWidth:0,width:200,itemWidth:100},series:seriesArray}




 
var latestYear=yearsExtremesForData[1];var firstYear=yearsExtremesForData[0];if(type=="scatter"){seriesArray=[];var indicator1=indicators[0];var indicator2=indicators[1];series=[];var globalType;var indicatorSuffix;for(i=0;i<3;i++){switch(i){case 0:globalType="Global Minimum";indicatorSuffix="min";break;case 1:globalType="Global Maximum";indicatorSuffix="max";break;case 2:globalType="Global Average";indicatorSuffix="avg";break;}
dataArray=[];_.forEach(statsCells,function(c){dataArray.push({x:c[indicator1+"__amount_"+indicatorSuffix],y:c[indicator2+"__amount_"+indicatorSuffix],year:c.geometry__time});});var visible=size==3?true:false;series.push({name:globalType,data:dataArray,visible:visible,tooltip:{pointFormat:'<b>'+indicator1+':</b> {point.x}<br/><b>'+indicator2+':</b> {point.y}<br/><b>year :</b> {point.year}'},});}
_.forEach(_cells,function(c){if(latestYear==c.year){dataArray=[];_.forEach(_cells,function(d){if(c.region==d.region&&d.year>=firstYear&&d.year<=latestYear){if(!!d[indicator1+"__amount_"+dataType]&&!!d[indicator2+"__amount_"+dataType])
dataArray.push({x:d[indicator1+"__amount_"+dataType],y:d[indicator2+"__amount_"+dataType],year:d.year});}});series.push({name:c.region,data:dataArray,tooltip:{pointFormat:'<b>'+indicator1+':</b> {point.x}<br/><b>'+indicator2+':</b> {point.y}<br/><b>year :</b> {point.year}'},});}});var jsonScatter={chart:{type:'scatter',zoomType:'xy'},title:{text:title},subtitle:{text:subtitle},xAxis:{title:{enabled:true,text:indicatorsMeta[0][0].label+xUnits},startOnTick:true,endOnTick:true,showLastLabel:true},yAxis:{title:{text:indicatorsMeta[1][0].label+yUnits}},series:series}}
if(type=="bubble"){seriesArray=[];var indicator1=indicators[0];var indicator2=indicators[1];var indicator3=indicators[2];_.forEach(statsCells,function(c){if(latestYear===c.geometry__time){series["Global Minimum"]={data:[c[indicator1+"__amount_min"],c[indicator2+"__amount_min"],c[indicator3+"__amount_min"]],year:c.geometry__time};series["Global Maximum"]={data:[c[indicator1+"__amount_max"],c[indicator2+"__amount_max"],c[indicator3+"__amount_max"]],year:c.geometry__time};series["Global Average"]={data:[c[indicator1+"__amount_avg"],c[indicator2+"__amount_avg"],c[indicator3+"__amount_avg"]],year:c.geometry__time};}});_.forEach(_cells,function(c){if(c.region){series[c.region]=[];}});_.forEach(_cells,function(c){if(c.region){if(latestYear==c.year){series[c.region]={year:c.year,data:[c[indicator1+"__amount_"+dataType],c[indicator2+"__amount_"+dataType],c[indicator3+"__amount_"+dataType]]};}}});var counter=1;var countriesArr=[];for(var countryName in series){var visible=false;visible=true;seriesArray.push({name:countryName,data:[series[countryName].data],visible:counter>3||size==3?true:false,zIndex:counter++});}
var jsonBubble={chart:{type:'bubble',zoomType:'xy'},title:{text:title},subtitle:{text:subtitle},xAxis:{ title:{enabled:true,text:indicatorsMeta[0][0].label+xUnits},startOnTick:true,endOnTick:true,showLastLabel:true},yAxis:{title:{text:indicatorsMeta[1][0].label+yUnits}},zAxis:{title:{text:indicatorsMeta[2][0].label+zUnits}},series:seriesArray}}
if(type=="bar"){seriesArray=[];var data=[]; _.forEach(statsCells,function(c){if(latestYear==c.geometry__time){data.push(["Global Minimum",c[indicatorId+"__amount_min"]]);data.push(["Global Maximum",c[indicatorId+"__amount_max"]]);data.push(["Global Average",c[indicatorId+"__amount_avg"]]);}});_.forEach(_cells,function(c){if(c.region&&latestYear==c.year){data.push([c.region,c[indicatorId+"__amount_"+dataType]]);}});
seriesArray=[{name:indicatorsMeta[0][0].label,data:data}];var jsonBar={chart:{type:'column'},title:{text:title},subtitle:{text:subtitle},xAxis:{type:'category',labels:{rotation:-45,style:{fontSize:'13px',fontFamily:'Verdana, sans-serif'}}},yAxis:{min:0,title:{text:title
}},legend:{enabled:false},tooltip:{formatter:function(){var number=this.point.y
return indicatorsMeta[0][0].label+'<br/>'+this.key+': <b>'+Math.floor(this.point.y)+'</b>'}},series:seriesArray}}
var json;switch(type){case"line":json=jsonLine;break;case"bar":json=jsonBar;break;case"bubble":json=jsonBubble;break;case"scatter":json=jsonScatter;break;}
return{highcharts:json

};}}());(function(){window.vizModel={selectView:function(type){switch(type){case"countries":setTimeout(function(){window.visualization.createMap();},10);break;}},downloadData:function(format,indicator,evt){evt.stopPropagation();window.clickedIndicator=true;var groupId=vizModel.activeGroup().id;if(groupId!="all"){var urlTemplate="/api/slicer/cube/geometry/cubes_aggregate?cubes={indicator_id}&drilldown=geometry__country_level0@{groupId}|geometry__time@time&cut=geometry__country_level0@{groupId}:{region}&format={format}&cut=geometry__time:{yearFrom}-{yearTo}&order=time"}else{var urlTemplate="/api/slicer/cube/geometry/cubes_aggregate?cubes={indicator_id}&drilldown=geometry__time|geometry__country_level0@sovereignt&format={format}&cut=geometry__time:{yearFrom}-{yearTo}&order=time"}
var url=urlTemplate.replace(/{indicator_id}/g,indicator.id);url=url.replace(/{format}/g,format);url=url.replace(/{groupId}/g,groupId);url=url.replace(/{region}/g,vizModel.activeRegion());url=url.replace(/{yearFrom}/g,vizModel.activeYears()[0]);url=url.replace(/{yearTo}/g,vizModel.activeYears()[1]||vizModel.activeYears()[0]);window.open(url,'_blank');},selectYear:function(years){var yearsArray=[];var pickedFromDropdown=false;if(!(years instanceof Array)){yearsArray=[years];pickedFromDropdown=true;}else{yearsArray=years;}
vizModel.activeYears.removeAll();vizModel.activeYears(yearsArray);if(pickedFromDropdown){$("#filter-years").slider('values',0,years);$("#filter-years").slider('values',1,years);}},removeIndicator:function(selectedIndicator){var indicatorIndex=_.indexOf(vizModel.activeIndicators(),selectedIndicator);var categoriesModel=_.clone(vizModel.categoriesModel(),true);var sourcesModel=_.clone(vizModel.sourcesModel(),true);vizModel.activeIndicators.splice(indicatorIndex,1);vizModel.indicatorsModel.removeAll();_.forEach(vizModel.indicatorsModelMaster(),function(indicator){if(selectedIndicator.id==indicator.id){indicator.selected=!indicator.selected;}
vizModel.indicatorsModel.push(indicator);});vizModel.categoriesModel.removeAll();_.forEach(categoriesModel,function(category){_.forEach(category.indicators,function(indicator){if(selectedIndicator.id==indicator.id){indicator.selected=!indicator.selected;}});vizModel.categoriesModel.push(category);});vizModel.sourcesModel.removeAll();_.forEach(sourcesModel,function(source){_.forEach(source.indicators,function(indicator){if(selectedIndicator.id==indicator.id){indicator.selected=!indicator.selected;}});vizModel.sourcesModel.push(source);});window.utils.flipCardEvent();},selectSubcategory:function(selectedSubcategory,evt){evt.stopPropagation();var currentTarget=evt.currentTarget;var displayValue=$(currentTarget).next().css("display");if(displayValue=="none"){$(currentTarget).next().css("display","block");}else{$(currentTarget).next().css("display","none");}},selectIndicatorMultiple:function(selectedIndicator,evt,goToVisualize){if(goToVisualize){ window.location.href="data-visualization#f=1990|2014&i="+selectedIndicator.id+"&c=line&r=dos_region:all";return;}
window.clickedIndicator=true;var categoriesModel=_.clone(vizModel.categoriesModel(),true);var sourcesModel=_.clone(vizModel.sourcesModel(),true);vizModel.activeIndicators.removeAll();vizModel.indicatorsModel.removeAll();_.forEach(vizModel.indicatorsModelMaster(),function(indicator){if(selectedIndicator.id==indicator.id){indicator.selected=!indicator.selected;}
if(indicator.selected){vizModel.activeIndicators.push(indicator)}
vizModel.indicatorsModel.push(indicator);});vizModel.categoriesModel.removeAll();_.forEach(categoriesModel,function(category){_.forEach(category.indicators,function(indicator){if(selectedIndicator.id==indicator.id){indicator.selected=!indicator.selected;}});vizModel.categoriesModel.push(category);});vizModel.sourcesModel.removeAll();_.forEach(sourcesModel,function(source){_.forEach(source.indicators,function(indicator){if(selectedIndicator.id==indicator.id){indicator.selected=!indicator.selected;}});vizModel.sourcesModel.push(source);});window.utils.flipCardEvent();var filterValue=$("#filterIndicators")[0].value;vizModel.filterIndicators(null,{currentTarget:{value:filterValue}});},selectVizualization:function(type){var groupByRegion=vizModel.groupByRegion();var allowMultivariate=["scatter","bubble","radar","tree"];var allowSinglevariate=["line","bar","map"];var indicators=_.map(vizModel.activeIndicators(),function(indicator){return indicator.id;});var indicatorLabels=_.map(vizModel.activeIndicators(),function(indicator){return indicator.label;});var countries=_.map(vizModel.activeCountries(),function(country){return country.geounit;}); var isMultivariate=indicators.length>1;if(isMultivariate&&_.indexOf(allowMultivariate,type)>-1){}
if(isMultivariate&&_.indexOf(allowMultivariate,type)<0){window.modalTitle="Alert";window.modalMessage="Multiple indicators are supported by Scatter, Radar, and Tree charts";$('#modal').modal('show');return;}
if(!isMultivariate&&_.indexOf(allowSinglevariate,type)>-1){}
if(!isMultivariate&&_.indexOf(allowSinglevariate,type)<0){window.modalTitle="Alert";window.modalMessage="Single indicators are supported by Line and Bar charts";$('#modal').modal('show');return;}  
var hashString="f="+vizModel.activeYears().join("|")+"&i="+indicators.join("|")+
"&c="+type+
"&r="+countries.join("|");window.location.href="/data-visualization#"+hashString;},selectCountry:function(selectedCountry,evt,goToVisualize,breakdown){var isGroup=selectedCountry.geounit.indexOf(":all")==selectedCountry.geounit.length-4;selectedCountry=_.clone(selectedCountry,true);if(isGroup){ selectedCountry.label+=" Regions";}
if(!isGroup&&breakdown){ selectedCountry.label+=" Countries";selectedCountry.geounit+=":all";}
if(goToVisualize){ window.location.href="data-visualization#f=1990|2014&i=gdp_per_capita&c=line&r="+selectedCountry.geounit
return;}
if(selectedCountry.selected){return false;}
var countryLabel=selectedCountry.label;var countryId=selectedCountry.id;vizModel.activeCountries.push(selectedCountry);var countriesModelMaster=_.clone(vizModel.countriesModelMaster(),true);vizModel.countriesModelMaster.removeAll();var countryGroupings=_.clone(vizModel.countryGroupings(),true);vizModel.countryGroupings.removeAll();var activeGroupId=vizModel.activeGroup().id;_.forEach(countryGroupings,function(countryGroup,i){if(countryGroup.id==countryId){countryGroup.selected=true;}
_.forEach(countryGroup.regions,function(region){if(region.id==countryId&&region.label==countryLabel){region.selected=true;}
_.forEach(region.countries,function(country){ if(country.id==countryId){country.selected=true;}});});});_.forEach(countryGroupings,function(countryGroup,i){if(activeGroupId==countryGroup.id){vizModel.activeGroup(countryGroup);}
vizModel.countryGroupings.push(countryGroup);});var filterValue=$("#filterCountries")[0].value;vizModel.filterCountries(null,{currentTarget:{value:filterValue}});window.utils.highlightOnMap(vizModel,selectedCountry);},removeCountry:function(){var selectedCountry=arguments[0];var activeCountries=vizModel.activeCountries();var selectedIndex=_.indexOf(activeCountries,selectedCountry);vizModel.activeCountries.splice(selectedIndex,1);var countryLabel=selectedCountry.label;var countryId=selectedCountry.id;var countryGroupings=_.clone(vizModel.countryGroupings(),true);vizModel.countryGroupings.removeAll();var activeGroupId=vizModel.activeGroup().id;_.forEach(countryGroupings,function(countryGroup,i){if(countryGroup.id==countryId){countryGroup.selected=false;}
_.forEach(countryGroup.regions,function(region){if(region.id==countryId&&region.label==countryLabel){region.selected=false;}
_.forEach(region.countries,function(country){ if(country.id==countryId){country.selected=false;}});});});_.forEach(countryGroupings,function(countryGroup,i){if(activeGroupId==countryGroup.id){vizModel.activeGroup(countryGroup);}
vizModel.countryGroupings.push(countryGroup);});window.utils.removeOnMap(vizModel,selectedCountry);
},clearActiveCountries:function(){vizModel.activeCountries.removeAll();var countryGroupings=_.clone(vizModel.countryGroupings(),true);vizModel.countryGroupings.removeAll();var activeGroupId=vizModel.activeGroup().id;_.forEach(countryGroupings,function(countryGroup,i){countryGroup.selected=false;_.forEach(countryGroup.regions,function(region){region.selected=false;_.forEach(region.countries,function(country){ country.selected=false;});});});_.forEach(countryGroupings,function(countryGroup,i){if(activeGroupId==countryGroup.id){vizModel.activeGroup(countryGroup);}
vizModel.countryGroupings.push(countryGroup);});window.utils.clearOnMap(vizModel);},clearActiveIndicators:function(){vizModel.activeIndicators.removeAll();var categoriesModel=_.clone(vizModel.categoriesModel(),true);var sourcesModel=_.clone(vizModel.sourcesModel(),true);vizModel.indicatorsModel.removeAll();_.forEach(vizModel.indicatorsModelMaster(),function(indicator){indicator.selected=false;vizModel.indicatorsModel.push(indicator);});vizModel.categoriesModel.removeAll();_.forEach(categoriesModel,function(category){_.forEach(category.indicators,function(indicator){indicator.selected=false;});vizModel.categoriesModel.push(category);});vizModel.sourcesModel.removeAll();_.forEach(sourcesModel,function(source){_.forEach(source.indicators,function(indicator){indicator.selected=false;});vizModel.sourcesModel.push(source);});window.utils.flipCardEvent();},selectCountryGroup:function(){var groupId=arguments[0].id;window.visualization.changeGroup(groupId);vizModel.activeGroup(arguments[0]);vizModel.activeRegion(""); vizModel.countryGroupRegions.removeAll();if(groupId=="all"){vizModel.selectCountryGroupRegion("all");}else{ _.forEach(vizModel.countryGroupings(),function(countryGroup){if(groupId==countryGroup.id){vizModel.countryGroupRegions(_.clone(countryGroup.regions,true));vizModel.selectCountryGroupRegion(countryGroup.regions[0]);}});}},selectCountryGroupRegion:function(){var selectedRegion=arguments[0];var selectedGroup=vizModel.activeGroup();vizModel.activeRegion(selectedRegion);vizModel.countriesModel.removeAll();var countriesModelMaster=_.clone(vizModel.countriesModelMaster(),true);_.forEach(countriesModelMaster,function(country){if(selectedRegion.id=="all"){vizModel.countriesModel.push(country);}else if(_.has(country.regions,selectedGroup.id)&&country.regions[selectedGroup.id]==selectedRegion.id){vizModel.countriesModel.push(country);}})
},expandMap:function(){var expanded=$(".countries-list .countries-col").css("display")=="none";if(expanded){$(".countries-list .countries-col").css("display","block");$(".countries-list .map-col").css("width","");}else{$(".countries-list .countries-col").css("display","none");$(".countries-list .map-col").css("width","100%");}
map.invalidateSize();},expandCategory:function(model,evt){window.expandedCategory=true;},clearFilter:function(){var current=vizModel.selectionTracker();current.filter=false;vizModel.selectionTracker(current);},clearIndicator:function(){var current=vizModel.selectionTracker();current.indicator=false;vizModel.selectionTracker(current);},clearChart:function(){var current=vizModel.selectionTracker();current.vizualization=false;vizModel.selectionTracker(current);},selectionTracker:ko.observable({filter:false,indicator:false,vizualization:false}),filterIndicators:function(m,evt){var value=evt.currentTarget.value;var indicators=vizModel.indicatorsModelMaster();vizModel.indicatorsModel.removeAll();for(var x in indicators){if(indicators[x].label.toLowerCase().indexOf(value.toLowerCase())>=0){vizModel.indicatorsModel.push(indicators[x]);}}
return true;},filterCountries:function(m,evt){var value=evt.currentTarget.value;var activeGroup=_.clone(vizModel.activeGroup(),true);_.forEach(activeGroup.regions,function(r){var countries=r.countries;_.forEach(countries,function(c){if(c.label.toLowerCase().indexOf(value.toLowerCase())>=0){c.filtered=true;}else{c.filtered=false;}})});vizModel.activeGroup(activeGroup);return true;},groupChange:function(){debugger;},filterCountry:ko.observable(""),hasCountryFilter:ko.observable(false),activeCard:ko.observable(""),activeYears:ko.observableArray([1990,2014]),activeIndicator:ko.observable(""),activeIndicators:ko.observableArray([]),activeIndicatorId:ko.observable(""),activeChart:ko.observable(""), activeData:ko.observable({}), categoriesModel:ko.observableArray([]),sourcesModel:ko.observableArray([]),indicatorsModel:ko.observableArray([]),indicatorsModelMaster:ko.observableArray([]),activeCountries:ko.observableArray([]),activeGroup:ko.observable({"id":"all","label":"All Countries","regions":[]}),activeRegion:ko.observable(""),groupByRegion:ko.observable(false),countriesModel:ko.observableArray([]),countriesModelMaster:ko.observableArray([]),countryGroupings:ko.observableArray([{"id":"all","label":"All Countries","regions":[]},{"id":"continent","label":"Continent","regions":[]},{"id":"dod_cmd","label":"Department of Defense","regions":[]},{"id":"dos_region","label":"Department of State","regions":[]},{"id":"usaid_reg","label":"USAID","regions":[]},{"id":"wb_inc_lvl","label":"Income Groups","regions":[]}]),countryGroupRegions:ko.observableArray([]),newSearch:ko.observable(true)}
window.vizModel.filterCountry.subscribe(function(newValue){vizModel.hasCountryFilter(newValue.length>0);});window.vizModel.groupByRegion.subscribe(function(newValue){});}());(function(){window.visualization={};window.clickedIndicator=false;window.expandedCategory=false;var mapCreated=false;window.map;window.visualization.geoJsonLayers={};window.visualization.geoJson={};window.modalTitle="";window.modalMessage="";$('#modal').modal({show:false,keyboard:false}); $('#modal').on('show.bs.modal',function(event){var modal=$(this)
modal.find('.modal-title').text(window.modalTitle);modal.find('.modal-body').text(window.modalMessage);});$(function(){});var geoJSONHandler=function(response,type){function onEachFeature(feature,layer){if(feature.properties){var name=feature.properties.sovereignt||feature.properties.usaid_reg||feature.properties.continent||feature.properties.dod_cmd||feature.properties.dos_region||feature.properties.wb_inc_lvl;layer.bindPopup(name);}}
window.visualization.lastGeoJson=response; window.visualization.geoJson[type]=response;window.visualization.geoJsonLayers[type]=L.geoJson(response,{style:{weight:0, opacity:1,color:'gray',fillOpacity:0.0, fillColor:'#cccccc'},onEachFeature:onEachFeature});for(var _type in window.visualization.geoJsonLayers){if(type==_type){map.addLayer(window.visualization.geoJsonLayers[_type]);}}}
window.visualization.changeGroup=function(groupId){if(groupId=="all"){groupId="sovereignt";}
if(!window.visualization.geoJsonLayers[groupId]){window.loader.loadGeoJSON(groupId,geoJSONHandler);}else{
}}
window.visualization.createMap=function(){var defaultType="sovereignt";if(!mapCreated){mapCreated=true;map=L.map('map').setView([0,0],1);L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://mapbox.com">Mapbox</a>',maxZoom:18}).addTo(map); window.visualization.changeGroup("all");}}
var eventBind=function(){$(".list-group-item").popover({trigger:"hover"});window.utils.flipCardEvent();}
var model=window.vizModel;var countriesListLoadHandler=function(response){window.utils.bindCountries(response,model);}
var indicatorListLoadHandler=function(response){window.utils.bindIndicators(response,model); ko.applyBindings(model);eventBind();}
window.loader.loadIndicatorList(window.config.server+window.config.services.categories,indicatorListLoadHandler);window.loader.loadCountries("",countriesListLoadHandler);var indicatorDataLoadHandler=function(response){var highChartsJson=window.prepareHighchartsJson(response,model.activeChart(),model.activeIndicators(),model.activeGroup(),model.activeRegion());console.log("here");model.activeData(highChartsJson);var highChartsJson=model.activeData();highChartsJson.title.text=model.activeIndicator();highChartsJson.chart.type=model.activeChart();highChartsJson.yAxis.title.text="";$('#viz-container').highcharts(model.activeData());$("#loading").hide();}}());